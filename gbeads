#!/usr/bin/env bash
# gbeads - GitHub issue wrapper for work organization
#
# A lightweight CLI that wraps `gh` to provide work organization
# primitives using GitHub issues with type labels and YAML frontmatter.

set -euo pipefail

readonly VERSION="0.1.0"

# Get the GitHub repo in owner/repo format from git remote
get_repo() {
  local remote_url
  remote_url=$(git remote get-url origin 2>/dev/null) || {
    echo ""
    return 1
  }

  # Handle SSH format: git@github.com:owner/repo.git
  if [[ "$remote_url" =~ git@github\.com:([^/]+)/(.+)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
    return 0
  fi

  # Handle HTTPS format: https://github.com/owner/repo.git
  if [[ "$remote_url" =~ https://github\.com/([^/]+)/(.+)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
    return 0
  fi

  echo ""
  return 1
}

# Require that we're in a git repo with a GitHub remote
# Sets REPO variable on success, exits on failure
require_repo() {
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: Not in a git repository" >&2
    exit 1
  fi

  REPO=$(get_repo)
  if [[ -z "$REPO" ]]; then
    echo "Error: Could not determine GitHub repository from git remote" >&2
    echo "Make sure 'origin' points to a GitHub repository." >&2
    exit 1
  fi

  export REPO
}

usage() {
  cat <<EOF
gbeads - GitHub issue wrapper for work organization

Usage:
  gbeads <command> [options]

Commands:
  init                Create type labels in current repo
  create <type> "title"   Create a typed issue (feature|story|task|bug)
  list                List issues with optional filters
  show <number>       Show issue details
  claim <number> <id> Claim an issue for a worker
  unclaim <number>    Release a claimed issue
  update <number>     Update issue title or type
  close <number>      Close an issue
  reopen <number>     Reopen a closed issue
  children <number>   Manage child issues in task list

Options:
  -h, --help          Show this help message
  -v, --version       Show version

Examples:
  gbeads init
  gbeads create task "Implement login form"
  gbeads create feature "User authentication" --parent 5
  gbeads list --type task --unclaimed
  gbeads claim 12 agent-001
  gbeads update 12 --title "New title"

EOF
}

version() {
  echo "gbeads version $VERSION"
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  case "$1" in
    -h | --help)
      usage
      exit 0
      ;;
    -v | --version)
      version
      exit 0
      ;;
    init | create | list | show | claim | unclaim | update | close | reopen | children)
      echo "Error: Command '$1' not yet implemented" >&2
      exit 1
      ;;
    *)
      echo "Error: Unknown command '$1'" >&2
      echo "Run 'gbeads --help' for usage information." >&2
      exit 1
      ;;
  esac
}

# Only run main if this script is being executed (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
